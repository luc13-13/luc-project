<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lc.product.center.mapper.ProductInfoMapper">

    <!-- 通用字段列表 -->
    <sql id="Base_Select">
        SELECT id, tenant_id, product_code, sub_product_code, billing_item_code, sub_billing_item_code,
        product_name, sub_product_name, billing_item_name, sub_billing_item_name,
        spec_value, spec_unit, base_price, price_factor, metering_unit, status, sort_order, deleted,
        created_by, dt_created, modified_by, dt_modified FROM product_info
    </sql>

    <!-- 动态条件查询（唯一的查询入口） -->
    <select id="selectByCondition" resultType="com.lc.product.center.domain.entity.ProductInfoDO"
            parameterType="com.lc.product.center.domain.dto.ProductInfoDTO">
        <include refid="Base_Select"/>
        <where>
            deleted = 0
            <if test="tenantId != null and tenantId != ''">
                AND tenant_id = #{tenantId}
            </if>
            <if test="productCode != null and productCode != ''">
                AND product_code = #{productCode}
            </if>
            <if test="subProductCode != null and subProductCode != ''">
                AND sub_product_code = #{subProductCode}
            </if>
            <if test="billingItemCode != null and billingItemCode != ''">
                AND billing_item_code = #{billingItemCode}
            </if>
            <if test="subBillingItemCode != null and subBillingItemCode != ''">
                AND sub_billing_item_code = #{subBillingItemCode}
            </if>
            <if test="productName != null and productName != ''">
                AND product_name LIKE CONCAT('%', #{productName}, '%')
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
        </where>
        ORDER BY sort_order ASC, dt_created DESC
    </select>

    <!-- 获取去重编码列表（特殊需求，无法复用通用查询） -->
    <select id="findDistinctProductCodes" resultType="java.lang.String">
        SELECT DISTINCT product_code
        FROM product_info
        WHERE tenant_id = #{tenantId} AND deleted = 0
        ORDER BY product_code
    </select>

    <select id="findDistinctSubProductCodes" resultType="java.lang.String">
        SELECT DISTINCT sub_product_code
        FROM product_info
        WHERE tenant_id = #{tenantId} AND product_code = #{productCode} AND deleted = 0
        ORDER BY sub_product_code
    </select>

    <select id="findDistinctBillingItemCodes" resultType="java.lang.String">
        SELECT DISTINCT billing_item_code
        FROM product_info
        WHERE tenant_id = #{tenantId} AND product_code = #{productCode} 
              AND sub_product_code = #{subProductCode} AND deleted = 0
        ORDER BY billing_item_code
    </select>

</mapper>
